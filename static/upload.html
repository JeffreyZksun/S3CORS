<!DOCTYPE html>
<html> 
  <head>
    <title>S3 POST Form</title> 
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8" />
	<script src='http://ajax.googleapis.com/ajax/libs/jquery/1.6.4/jquery.min.js'></script>
    <script src='http://ajax.googleapis.com/ajax/libs/jqueryui/1.8.16/jquery-ui.min.js'></script> 
    <script src='sha1.js'></script> 
	<script>		
		function authorizedUpload() {
			var bucket = 'your bucket';
			var AWSSecretKeyId = 'your key id';
			var AWSSecretAccessKey='your access key';
			
			var POLICY_JSON = { "expiration": "2020-12-01T12:00:00.000Z",
				"conditions": [
					{"bucket": bucket},
					["starts-with", "$key", ""],
					{"acl": 'public-read'},                           
					["starts-with", "$Content-Type", ""],
					["content-length-range", 0, 524288000]
				]
			  };

			var policyBase64 = btoa(JSON.stringify(POLICY_JSON));
			var signature = b64_hmac_sha1(AWSSecretAccessKey, policyBase64);

			var file = document.getElementById('file').files[0];
			var fd = new FormData();

			var key = (new Date).getTime() + '-' + file.name;

			fd.append('key', key);
			fd.append('acl', 'public-read'); 
			fd.append('Content-Type', file.type);      
			fd.append('AWSAccessKeyId', AWSSecretKeyId);
			
			// Omit the policy and signature for simplify.
			fd.append('policy', policyBase64)
			fd.append('signature',signature);

			fd.append("file",file);

			var xhr = new XMLHttpRequest(); 

			xhr.upload.addEventListener("progress", uploadProgress, false);
			xhr.addEventListener("load", uploadComplete, false);
			xhr.addEventListener("error", uploadFailed, false);
			xhr.addEventListener("abort", uploadCanceled, false);

			xhr.open('POST', 'https://'+bucket+'.s3.amazonaws.com/', true); //MUST BE LAST LINE BEFORE YOU SEND 
			xhr.send(fd);
		  }
		  
		  function anonymousUpload() {
			// This is the anonymous upload. It requires the bucket permission is "Grant every upload/delete permissions".
			var bucket = 'your bucket';
			
			var file = document.getElementById('file').files[0];
			var fd = new FormData();

			var key = (new Date).getTime() + '-' + file.name;

			fd.append('key', key);	
			fd.append("file",file);

			var xhr = new XMLHttpRequest(); 

			xhr.upload.addEventListener("progress", uploadProgress, false);
			xhr.addEventListener("load", uploadComplete, false);
			xhr.addEventListener("error", uploadFailed, false);
			xhr.addEventListener("abort", uploadCanceled, false);

			xhr.open('POST', 'https://'+bucket+'.s3.amazonaws.com/', true); //MUST BE LAST LINE BEFORE YOU SEND 
			xhr.send(fd);
		  }
		  
		  function uploadProgress(evt) {
			if (evt.lengthComputable) {
			  var percentComplete = Math.round(evt.loaded * 100 / evt.total);
			  document.getElementById('progressNumber').innerHTML = percentComplete.toString() + '%';
			}
			else {
			  document.getElementById('progressNumber').innerHTML = 'unable to compute';
			}
		  }

		  function uploadComplete(evt) {
			/* This event is raised when the server send back a response */
			alert("Done - " + evt.target.responseText );
			console.log("Done - " + evt.target.responseText );
		  }

		  function uploadFailed(evt) {
			alert("There was an error attempting to upload the file." + JSON.stringify(evt));
		  }

		  function uploadCanceled(evt) {
			alert("The upload has been canceled by the user or the browser dropped the connection.");
		  }
	</script>
  </head>

  <body> 
     <form id="form1" enctype="multipart/form-data" method="post">
		<div class="row">
		  <label for="file">Select a File to Upload</label>
		  <input type="file" name="file" id="file"/>
		</div>
		<div class="row">
		  <input type="button" onclick="authorizedUpload()" value="Authorized Upload" />
		  <input type="button" onclick="anonymousUpload()" value="Anonymous Upload" />
		</div>
		<div id="progressNumber"></div>
	</form>
  </body>
</html>